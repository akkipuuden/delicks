<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Delick's - ERP Industrial V5</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root {
            --brand-yellow: #FFD600; --brand-red: #C62828; --brand-dark: #3E2723;
            --bg-body: #ECEFF1; --bg-app: #FAFAFA; --surface: #FFFFFF;
            --success: #43A047; --warning: #FF8F00; --info: #1E88E5; --purple: #8E24AA;
            --radius: 16px; --shadow: 0 8px 24px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Nunito', sans-serif; background-color: var(--bg-body); color: var(--brand-dark); margin: 0; padding: 0; height: 100vh; display: flex; justify-content: center; }
        
        #app-wrapper { width: 100%; max-width: 480px; background-color: var(--bg-app); height: 100%; position: relative; box-shadow: 0 0 40px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        #main-content { flex: 1; overflow-y: auto; padding-bottom: 90px; scroll-behavior: smooth; }

        header { background-color: var(--brand-yellow); padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 50; }
        .brand-logo { height: 40px; object-fit: contain; }
        
        .view { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        h2 { color: var(--brand-dark); margin-top: 0; font-weight: 800; }
        h3 { color: var(--brand-red); margin-top: 0; }
        h4 { margin: 0 0 10px 0; color: var(--brand-dark); }
        .card { background: var(--surface); border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.02); }
        
        /* Dashboards & Grids */
        .ai-card { background: linear-gradient(135deg, #1E88E5, #1565C0); color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 20px; position: relative; overflow: hidden; }
        .ai-card i.bg-icon { position: absolute; right: -10px; bottom: -10px; font-size: 6rem; opacity: 0.1; }
        
        .tax-card { background: linear-gradient(135deg, var(--purple), #6A1B9A); color: white; padding: 20px; border-radius: var(--radius); margin-bottom: 20px; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .stat-box { background: white; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #eee; }
        .stat-val { font-size: 1.2rem; font-weight: 800; display: block; margin-top: 5px; }
        
        .progress-track { background: #EEEEEE; height: 12px; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--brand-yellow), orange); width: 0%; transition: width 1s ease; }

        /* OP Status Badges */
        .status-badge { font-size: 0.7rem; padding: 4px 8px; border-radius: 8px; font-weight: bold; }
        .status-aberta { background: #E3F2FD; color: #1565C0; }
        .status-producao { background: #FFF3E0; color: #E65100; }
        .status-concluida { background: #E8F5E9; color: #2E7D32; }
        .status-cancelada { background: #FFEBEE; color: #C62828; }

        /* Tables & Lists */
        .dre-table { width: 100%; border-collapse: collapse; font-size: 0.85rem; margin-bottom: 10px; }
        .dre-table td { padding: 8px 0; border-bottom: 1px dashed #eee; }
        .dre-table tr.total td { font-weight: 800; border-top: 2px solid #ccc; font-size: 0.95rem; }
        
        .product-item { background: white; padding: 15px; margin-bottom: 12px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; }
        .prod-info h4 { font-size: 0.95rem; }
        .prod-info p { margin: 4px 0 0 0; font-size: 0.8rem; color: #777; }

        /* Forms & Buttons */
        .btn { width: 100%; padding: 14px; border-radius: 10px; border: none; font-weight: 700; font-size: 0.95rem; cursor: pointer; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--brand-red); color: white; box-shadow: 0 4px 15px rgba(198, 40, 40, 0.3); }
        .btn-secondary { background: var(--brand-yellow); color: var(--brand-dark); }
        .btn-outline { background: transparent; border: 2px solid #ccc; color: #555; }
        .btn-small { padding: 6px 12px; font-size: 0.8rem; width: auto; margin:0; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; margin-bottom: 10px; font-family: inherit; outline: none; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { padding: 8px 15px; background: #eee; border-radius: 20px; border: none; font-size: 0.85rem; font-weight: bold; color: #555; white-space: nowrap; cursor: pointer; }
        .tab-btn.active { background: var(--brand-dark); color: var(--brand-yellow); }

        /* Nav */
        .bottom-nav { position: absolute; bottom: 0; left: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 12px 0; box-shadow: 0 -4px 20px rgba(0,0,0,0.05); z-index: 100; border-top: 1px solid #eee; }
        .nav-item { text-align: center; color: #9E9E9E; font-size: 0.7rem; text-decoration: none; flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-item i { font-size: 1.3rem; }
        .nav-item.active { color: var(--brand-red); font-weight: bold; }

        /* Cart Float */
        .cart-float { position: absolute; bottom: 90px; right: 20px; background: var(--brand-red); color: white; width: 60px; height: 60px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 1.5rem; box-shadow: 0 4px 15px rgba(198, 40, 40, 0.4); cursor: pointer; z-index: 90; }
        .cart-badge { position: absolute; top: -5px; right: -5px; background: var(--brand-yellow); color: var(--brand-dark); width: 22px; height: 22px; border-radius: 50%; font-size: 0.8rem; font-weight: 800; display: flex; align-items: center; justify-content: center; }

        /* Modals & Toasts */
        .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 200; display: none; justify-content: center; align-items: flex-end; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: white; width: 100%; border-top-left-radius: 24px; border-top-right-radius: 24px; padding: 25px; max-height: 85%; overflow-y: auto; }
        .modal-center { align-items: center; } .modal-center .modal-content { width: 90%; border-radius: 24px; max-width: 400px; }
       /* ================= TOAST NOTIFICATIONS (AVISOS) ================= */
        #toast-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; flex-direction: column; gap: 10px; z-index: 9999;
            pointer-events: none; width: 90%; max-width: 400px;
        }
        
        .toast {
            background: white; color: var(--brand-dark); padding: 14px 16px; 
            border-radius: 12px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
            font-size: 0.9rem; font-weight: 700; display: flex; align-items: center; 
            gap: 12px; pointer-events: auto; position: relative; overflow: hidden; 
            touch-action: none; /* Previne scroll da tela ao arrastar o toast */
            border-left: 5px solid #333;
            animation: slideDownToast 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .toast.success { border-left-color: var(--success); }
        .toast.error { border-left-color: var(--brand-red); }
        .toast.info { border-left-color: var(--info); }
        
        .toast-icon { font-size: 1.3rem; }
        .toast.success .toast-icon { color: var(--success); }
        .toast.error .toast-icon { color: var(--brand-red); }
        .toast.info .toast-icon { color: var(--info); }
        
        .toast-content { flex: 1; margin-top: 2px; }
        
        .toast-close {
            background: none; border: none; color: #aaa; font-size: 1.2rem;
            cursor: pointer; padding: 0; margin-left: auto; display: flex;
            align-items: center; justify-content: center; width: 30px; height: 30px;
            transition: color 0.2s;
        }
        .toast-close:hover { color: #333; }
        
        @keyframes slideDownToast { 
            from { transform: translateY(-150%); opacity: 0; } 
            to { transform: translateY(0); opacity: 1; } 
        }
        @keyframes slideUpOut { 
            from { transform: translateY(0); opacity: 1; margin-top: 0; } 
            to { transform: translateY(-150%); opacity: 0; margin-top: -60px; } 
        }
        
        /* NFC & DANFE */
        .nfc-zone { text-align: center; padding: 30px; border: 2px dashed #ccc; border-radius: var(--radius); background: #f9f9f9; }
        .danfe-box { background: #fff; border: 1px solid #000; padding: 15px; font-family: 'Arial', sans-serif; font-size: 0.75rem; color: #000; }
        .barcode-mock { height: 35px; background: repeating-linear-gradient(90deg, #000, #000 2px, transparent 2px, transparent 4px, #000 4px, #000 5px, transparent 5px, transparent 8px); margin: 10px 0; }
		/* NF List & Finance */
        .nf-item {
            background: white; border: 1px solid #eee; border-radius: 12px; padding: 12px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: transform 0.1s;
        }
        .nf-item:active { transform: scale(0.98); }
        .nf-info h4 { margin: 0 0 5px 0; font-size: 0.95rem; color: var(--brand-dark); }
        .nf-info p { margin: 0; font-size: 0.8rem; color: #777; }
        .nf-val { text-align: right; }
        .nf-val strong { display: block; font-size: 1.05rem; }
        .status-paga { background: #E8F5E9; color: #2E7D32; }
        .status-pendente { background: #FFF3E0; color: #E65100; }
    </style>
</head>
<body>

<div id="app-wrapper">
    <div id="toast-container"></div>

    <header>
        <img src="https://static.wixstatic.com/media/e87d5a_121fa3ebb2984c7485b6f88a86e6f70a~mv2.png" alt="Delick's" class="brand-logo">
        <div style="color:var(--brand-dark); font-weight:bold; font-size:0.9rem;"><i class="fas fa-industry"></i> Indústria V5</div>
    </header>

    <div id="main-content">
        
        <div id="view-home" class="view active">
            <div class="card" style="padding-bottom:10px;">
                <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                    <h3 style="margin:0; color: var(--brand-dark);">Progresso Mensal</h3>
                    <span style="font-weight:700; color:var(--brand-red);" id="progress-txt">0%</span>
                </div>
                <div class="progress-track"><div class="progress-fill" id="progress-bar"></div></div>
                <p style="text-align:right; font-size:0.8rem; color:#999; margin-top:5px;">Meta: <span id="target-val">R$ 50.000,00</span></p>
            </div>

            <div class="ai-card">
                <i class="fas fa-chart-line bg-icon"></i>
                <h3 style="color:var(--brand-yellow); margin-bottom:5px;"><i class="fas fa-tachometer-alt"></i> Performance Industrial</h3>
                <div class="stats-grid" style="margin-top:15px; margin-bottom:0;">
                    <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:8px; text-align:center;">
                        <span style="font-size:0.8rem; opacity:0.8;">CMV Global</span>
                        <strong style="display:block; font-size:1.2rem;">38.4%</strong>
                    </div>
                    <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:8px; text-align:center;">
                        <span style="font-size:0.8rem; opacity:0.8;">Taxa de Perda</span>
                        <strong style="display:block; font-size:1.2rem; color:#69F0AE;">1.2%</strong>
                    </div>
                    <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:8px; text-align:center;">
                        <span style="font-size:0.8rem; opacity:0.8;">Giro Estoque</span>
                        <strong style="display:block; font-size:1.2rem;">14 dias</strong>
                    </div>
                    <div style="background:rgba(255,255,255,0.1); padding:10px; border-radius:8px; text-align:center;">
                        <span style="font-size:0.8rem; opacity:0.8;">Produto Curva A</span>
                        <strong style="display:block; font-size:1rem;">Mini Kibe</strong>
                    </div>
                </div>
            </div>

<div class="tax-card">
                <h3 style="color:var(--brand-yellow); margin-bottom:5px;"><i class="fas fa-balance-scale"></i> Auditoria Fiscal IA (NCM)</h3>
                <p style="font-size:0.85rem; margin:0 0 10px 0; opacity: 0.9;">O sistema varreu seus produtos em busca de elisão fiscal.</p>
                
                <div style="background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; font-size: 0.85rem; margin-bottom:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:8px; margin-bottom:8px;">
                        <strong>Pão de Queijo (Pct 2kg)</strong>
                        <span class="status-badge" style="background:#FF8A80; color:#b71c1c;">NCM Atual: 1905.90.90</span>
                    </div>
                    <div style="color:#69F0AE; margin-bottom:8px; line-height:1.4;">
                        <i class="fas fa-lightbulb"></i> <strong>Sugestão de Enquadramento:</strong><br>
                        Alterar para NCM <strong>1901.20.00</strong> (Misturas para produtos de padaria).
                    </div>
                    <div style="font-size:0.8rem; border-top:1px dashed rgba(255,255,255,0.2); padding-top:8px;">
                        Impacto: Redução de <strong>3.5%</strong> no ICMS-ST / PIS-COFINS.
                        <br>Economia projetada: <strong>R$ 1.250,00/mês</strong>.
                    </div>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; font-size:0.8rem; background:rgba(255,255,255,0.1); padding:8px; border-radius:8px;">
                    <span>Regime Tributário Ideal Atual:</span>
                    <span style="color:#69F0AE; font-weight:bold;">Simples Nacional</span>
                </div>
            </div>
        </div>

        <div id="view-finance" class="view">
            <h2>Gestão Financeira</h2>
            
            <div class="stats-grid">
                <div class="stat-box">
                    <span style="font-size:0.8rem; color:#777;">Caixa Atual</span>
                    <span class="stat-val val-dark">R$ 24.500,00</span>
                </div>
                <div class="stat-box" style="border-left: 3px solid var(--success);">
                    <span style="font-size:0.8rem; color:#777;">A Receber (Vendas)</span>
                    <span class="stat-val" style="color:var(--success)" id="fin-receber">R$ 0,00</span>
                </div>
                <div class="stat-box" style="border-left: 3px solid var(--brand-red);">
                    <span style="font-size:0.8rem; color:#777;">A Pagar (Insumos)</span>
                    <span class="stat-val" style="color:var(--brand-red)">R$ 3.150,00</span>
                </div>
                <div class="stat-box" style="border-left: 3px solid var(--info);">
                    <span style="font-size:0.8rem; color:#777;">Fluxo Projetado (30d)</span>
                    <span class="stat-val" style="color:var(--info)">+ R$ 5.170,00</span>
                </div>
            </div>

            <div class="card">
                <h4><i class="fas fa-file-invoice-dollar" style="color:var(--brand-yellow);"></i> DRE Simplificado (Mês Atual)</h4>
<table class="dre-table">
                    <tr><td>Receita Bruta de Vendas</td><td style="text-align:right; color:green;" id="dre-receita">R$ 0,00</td></tr>
                    <tr><td>(-) Impostos Incidentes (6.8%)</td><td style="text-align:right; color:red;" id="dre-imposto">R$ 0,00</td></tr>
                    <tr style="background:#f9f9f9; font-weight:bold;"><td>(=) Receita Líquida</td><td style="text-align:right;" id="dre-liquida">R$ 0,00</td></tr>
                    <tr><td>(-) CMV (Custo Insumos Baixados)</td><td style="text-align:right; color:red;" id="dre-cmv">R$ 0,00</td></tr>
                    <tr><td>(-) Despesas Fixas / Operacionais</td><td style="text-align:right; color:red;">R$ 4.500,00</td></tr>
                    <tr class="total"><td>(=) Lucro Líquido Operacional</td><td style="text-align:right; color:green;" id="dre-lucro">R$ 0,00</td></tr>
                </table>
            </div>
            
            <div class="card">
                <h4><i class="fas fa-building" style="color:var(--brand-yellow);"></i> Centro de Custo (Perdas/Desperdício)</h4>
                <p style="font-size:0.85rem; color:#666;">Total de perdas registradas na produção: <strong>R$ 145,50</strong> (NFC Logs).</p>
            </div>
			<div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h4 style="margin:0;"><i class="fas fa-file-invoice" style="color:var(--info);"></i> Notas Fiscais Emitidas</h4>
                    <select id="nf-client-filter" class="form-control" style="width:140px; margin:0; padding:6px; font-size:0.8rem;" onchange="renderNFList()">
                        <option value="ALL">Todos os Clientes</option>
                    </select>
                </div>
                
                <div id="nf-list-container" style="max-height: 250px; overflow-y: auto; padding-right: 5px;"></div>
                
                <div style="border-top:2px solid #eee; margin-top:10px; padding-top:10px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-size:0.85rem; color:#666;">Total Filtrado:</span>
                    <strong style="font-size:1.2rem; color:var(--brand-dark);" id="nf-total-filtered">R$ 0,00</strong>
                </div>
            </div>
        </div>

        <div id="view-production" class="view">
            <h2>Chão de Fábrica</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchProdTab('nova')" id="tab-nova">Nova OP</button>
                <button class="tab-btn" onclick="switchProdTab('lista')" id="tab-lista">Gestão de OPs</button>
                <button class="tab-btn" onclick="switchProdTab('nfc')" id="tab-nfc">Tablet NFC</button>
            </div>

            <div id="prod-nova-content">
                <div class="card">
                    <p style="font-size:0.85rem; color:#666; margin-top:0;">Gere OPs integradas com a Ficha Técnica (BOM).</p>
                    <label style="font-size:0.8rem; font-weight:bold;">Produto a Fabricar:</label>
                    <select id="op-product" class="form-control" onchange="previewBOM()"></select>
                    <label style="font-size:0.8rem; font-weight:bold;">Quantidade (Lotes):</label>
                    <input type="number" id="op-qty" class="form-control" value="1" min="1" onchange="previewBOM()">
                    
                    <div id="bom-preview" style="background:#f5f5f5; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.85rem; display:none;"></div>
                    <button class="btn btn-primary" onclick="createOP()"><i class="fas fa-plus"></i> Abrir Ordem de Produção</button>
                </div>
            </div>

            <div id="prod-lista-content" style="display:none;">
                <div id="op-list-container"></div>
            </div>

            <div id="prod-nfc-content" style="display:none;">
                <div id="nfc-locked" class="nfc-zone">
                    <i class="fas fa-id-badge" style="font-size:3rem; color:var(--info); cursor:pointer; margin-bottom:15px;" onclick="simulateNFC()"></i>
                    <h3>Autenticação Necessária</h3>
                    <p style="font-size:0.85rem; color:#777;">Aproxime o crachá do operador para retirar insumos ou registrar perdas no Centro de Custo.</p>
                </div>
                <div id="nfc-unlocked" style="display:none;">
                    <div class="card" style="background:var(--brand-yellow); padding:15px; display:flex; justify-content:space-between; align-items:center;">
                        <div><strong>Op: Carlos Moura</strong><br><small>Turno 1 - Cozinha</small></div>
                        <button class="btn" style="width:auto; padding:5px 10px; background:rgba(0,0,0,0.1); margin:0;" onclick="lockNFC()">Sair</button>
                    </div>
                    <h4>Apontamento de Perda / Sobra</h4>
                    <div id="tablet-raw-list"></div>
                </div>
            </div>
        </div>

        <div id="view-stock" class="view">
            <h2>Estoque e Compras</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchStockTab('raw')" id="tab-raw">Matéria-Prima</button>
                <button class="tab-btn" onclick="switchStockTab('finished')" id="tab-finished">Produtos Prontos</button>
                <button class="tab-btn" onclick="switchStockTab('nfe')" id="tab-nfe">Entrada NF-e</button>
            </div>
            <div id="stock-raw-content"></div>
            <div id="stock-finished-content" style="display:none;"></div>
            <div id="stock-nfe-content" style="display:none;">
                <div class="card nfc-zone">
                    <i class="fas fa-barcode" style="font-size:3rem; color:var(--brand-dark); margin-bottom:15px;"></i>
                    <p style="font-size:0.9rem;">Escaneie o XML do fornecedor para dar entrada nos insumos.</p>
                    <input type="text" id="nf-key" class="form-control" value="35231012345678000199550010001234561001234567" style="text-align:center; font-size:0.8rem;">
                    <button class="btn btn-primary" onclick="processNFE()">Processar XML</button>
                </div>
            </div>
        </div>

        <div id="view-sales" class="view">
            <h2>Comercial</h2>
            <div class="tabs">
                <button class="tab-btn active" onclick="switchSalesTab('pdv')" id="tab-pdv">PDV (Nova Venda)</button>
                <button class="tab-btn" onclick="switchSalesTab('cli')" id="tab-cli">Meus Clientes</button>
            </div>

            <div id="sales-pdv-content">
                <div style="background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee;">
                    <label style="font-size:0.8rem; font-weight:700; color:#999; display:block; margin-bottom:5px;">CLIENTE (DESTINATÁRIO)</label>
                    <select id="client-select" class="form-control" style="margin:0;"></select>
                </div>
                <div id="catalog-container"></div>
            </div>

            <div id="sales-cli-content" style="display:none;">
                <button class="btn btn-primary" onclick="openModal('client-modal')"><i class="fas fa-user-plus"></i> Novo Cliente</button>
                <ul id="clients-list" style="list-style:none; padding:0; margin-top: 10px;"></ul>
            </div>
        </div>

    </div>

    <div id="cart-btn" class="cart-float" onclick="openCart()">
        <i class="fas fa-shopping-basket"></i>
        <div class="cart-badge" id="cart-count">0</div>
    </div>

    <div id="cart-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 id="cart-title">Resumo do Pedido</h2>
                <i class="fas fa-times" onclick="closeModal('cart-modal')" style="font-size:1.5rem; color:#ccc; cursor:pointer;"></i>
            </div>
            <div id="cart-items" style="max-height: 50vh; overflow-y:auto; margin-bottom:20px;"></div>
            <div id="cart-footer">
                <div style="display:flex; justify-content:space-between; font-size:1.2rem; font-weight:800; color:var(--brand-dark); margin-bottom:20px; border-top:2px solid #eee; padding-top:15px;">
                    <span>Total da NF</span><span id="cart-total">R$ 0,00</span>
                </div>
                <button class="btn btn-primary" id="btn-finish-sale" onclick="generateDANFE()">Emitir NF-e e Faturar</button>
            </div>
        </div>
    </div>

    <div id="client-modal" class="modal-overlay modal-center">
        <div class="modal-content">
            <h3 id="cli-modal-title">Novo Cliente</h3>
            <input type="hidden" id="cli-id">
            <input type="text" id="cli-name" class="form-control" placeholder="Nome do cliente ou empresa">
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-danger" id="btn-del-cli" style="flex:0 0 auto; width:50px; display:none;" onclick="deleteClient()"><i class="fas fa-trash"></i></button>
                <button class="btn btn-primary" style="flex:1;" onclick="saveClient()">Salvar</button>
            </div>
            <button class="btn btn-outline" style="margin-top:10px;" onclick="closeModal('client-modal')">Cancelar</button>
        </div>
    </div>

    <div id="loss-modal" class="modal-overlay modal-center">
        <div class="modal-content">
            <h3>Registrar Perda de Insumo</h3>
            <p id="loss-item-name" style="font-weight:bold; color:var(--brand-red);"></p>
            <input type="hidden" id="loss-item-id">
            <label style="font-size:0.8rem;">Motivo da Perda:</label>
            <select id="loss-reason" class="form-control">
                <option value="Vencimento">Vencimento da Validade</option>
                <option value="Erro Produção">Erro de Produção / Queima</option>
                <option value="Embalagem">Embalagem Danificada</option>
            </select>
            <label style="font-size:0.8rem;">Quantidade Perdida:</label>
            <input type="number" id="loss-qty" class="form-control" value="1" min="1">
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button class="btn btn-outline" style="margin:0;" onclick="closeModal('loss-modal')">Cancelar</button>
                <button class="btn btn-primary" style="margin:0;" onclick="confirmLoss()">Apontar Perda</button>
            </div>
        </div>
    </div>
<div id="nf-manage-modal" class="modal-overlay modal-center">
        <div class="modal-content" style="max-width:400px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0;">NF-e <span id="manage-nf-num"></span></h3>
                <span id="manage-nf-status" class="status-badge"></span>
            </div>
            <p style="font-size:0.85rem; color:#666; margin-top:0;">Cliente: <strong id="manage-nf-client"></strong></p>
            
            <div style="background:#f9f9f9; padding:15px; border-radius:12px; margin-bottom:20px; text-align:center;">
                <span style="font-size:0.8rem; color:#777; display:block;">Valor Total da Nota</span>
                <strong style="font-size:1.5rem; color:var(--brand-dark);">R$ <span id="manage-nf-total"></span></strong>
            </div>
            
            <input type="hidden" id="manage-nf-id">
            
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button class="btn btn-primary" id="btn-pay-nf" onclick="toggleNFStatus()" style="background:var(--success); border:none;"><i class="fas fa-check-circle"></i> Confirmar Recebimento</button>
                <button class="btn btn-secondary" onclick="emitCCe()"><i class="fas fa-edit"></i> Emitir Carta de Correção (CC-e)</button>
                <button class="btn btn-outline" style="margin:0;" onclick="closeModal('nf-manage-modal')">Fechar</button>
            </div>
        </div>
    </div>
    <nav class="bottom-nav">
        <a href="#" class="nav-item active" onclick="navTo('home')" data-target="home"><i class="fas fa-home"></i> Início</a>
        <a href="#" class="nav-item" onclick="navTo('finance')" data-target="finance"><i class="fas fa-chart-line"></i> Finanças</a>
        <a href="#" class="nav-item" onclick="navTo('production')" data-target="production"><i class="fas fa-industry"></i> Produção</a>
        <a href="#" class="nav-item" onclick="navTo('stock')" data-target="stock"><i class="fas fa-boxes"></i> Estoque</a>
        <a href="#" class="nav-item" onclick="navTo('sales')" data-target="sales"><i class="fas fa-shopping-cart"></i> Comercial</a>
    </nav>
</div>

<script>
    // --- DATABASE ---
const db = {
        insumos: [
            { id: 101, name: "Farinha de Trigo (Kg)", stock: 85, cost: 3.50, min: 20 },
            { id: 102, name: "Peito de Frango (Kg)", stock: 42, cost: 18.00, min: 15 },
            { id: 103, name: "Óleo de Soja (L)", stock: 12, cost: 6.50, min: 10 },
            { id: 104, name: "Queijo Mussarela (Kg)", stock: 8, cost: 38.00, min: 5 }
        ],
        products: [
            { id: 1, name: "Mini Coxinha Frango (Pct 1kg)", cat: "Fritos", price: 25.00, stock: 30, ncmAtual: "1602.32.20", ncmSugestao: null, recipe: [{ id: 101, qty: 0.5 }, { id: 102, qty: 0.4 }, { id: 103, qty: 0.1 }] },
            { id: 2, name: "Bolinha de Queijo (Pct 1kg)", cat: "Fritos", price: 28.00, stock: 15, ncmAtual: "1902.20.00", ncmSugestao: null, recipe: [{ id: 101, qty: 0.6 }, { id: 104, qty: 0.4 }, { id: 103, qty: 0.1 }] },
            { id: 3, name: "Pão de Queijo (Pct 2kg)", cat: "Assados", price: 45.00, stock: 8, ncmAtual: "1905.90.90", ncmSugestao: "1901.20.00", taxDrop: "3.5%", recipe: [{ id: 101, qty: 0.8 }, { id: 104, qty: 0.8 }] }
        ],
        clients: ["Consumidor Final", "Padaria Central", "Mercado Silva"],
        // NOVO: Histórico de Vendas com Status e Número de Nota
        sales: [
            { id: 1708290000000, nfNum: "000.001240", date: "16/02/2026", client: "Padaria Central", total: 450.00, status: "Paga" },
            { id: 1708376400000, nfNum: "000.001241", date: "17/02/2026", client: "Mercado Silva", total: 1280.00, status: "Pendente" },
            { id: 1708462800000, nfNum: "000.001242", date: "18/02/2026", client: "Consumidor Final", total: 125.00, status: "Paga" }
        ],
        ops: [],
        cart: {},
        target: 50000
    };

    let opCounter = 1000;

    // --- UTILS ---
// --- UX: TOAST NOTIFICATIONS (MODERNAS) ---
    function showToast(msg, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        // Define o ícone com base no tipo
        const iconMap = { 'success': 'fa-check-circle', 'error': 'fa-exclamation-triangle', 'info': 'fa-info-circle' };
        const icon = iconMap[type] || iconMap['info'];

        // Estrutura HTML do Toast com o X de fechar
        toast.innerHTML = `
            <i class="fas ${icon} toast-icon"></i>
            <div class="toast-content">${msg}</div>
            <button class="toast-close"><i class="fas fa-times"></i></button>
        `;
        
        container.appendChild(toast);

        let isClosing = false;
        
        // Função para remover o aviso
        const closeToast = () => {
            if (isClosing) return;
            isClosing = true;
            toast.style.animation = 'slideUpOut 0.4s forwards';
            setTimeout(() => toast.remove(), 400); // Remove do DOM após a animação
        };

        // Evento de clique no X
        toast.querySelector('.toast-close').addEventListener('click', closeToast);

        // Auto-remover após 4 segundos
        let autoCloseTimeout = setTimeout(closeToast, 4000);

        // --- Lógica de Arrastar para Cima (Drag / Swipe) ---
        let startY = 0;
        let currentY = 0;
        let isDragging = false;

        const onDragStart = (e) => {
            isDragging = true;
            startY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            toast.style.transition = 'none'; // Desativa transição para seguir o dedo perfeitamente
            clearTimeout(autoCloseTimeout); // Pausa o timer se o usuário segurar o aviso
        };

        const onDragMove = (e) => {
            if (!isDragging) return;
            currentY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
            const diff = currentY - startY;
            
            // Só permite arrastar para cima (valores negativos)
            if (diff < 0) {
                toast.style.transform = `translateY(${diff}px)`;
                toast.style.opacity = 1 - (Math.abs(diff) / 100); // Vai ficando transparente
            }
        };

        const onDragEnd = (e) => {
            if (!isDragging) return;
            isDragging = false;
            toast.style.transition = 'transform 0.2s ease, opacity 0.2s ease';
            
            const diff = currentY - startY;
            
            // Se arrastou mais de 35px pra cima, fecha. Se não, volta pro lugar.
            if (diff < -35) {
                closeToast();
            } else {
                toast.style.transform = 'translateY(0)';
                toast.style.opacity = '1';
                autoCloseTimeout = setTimeout(closeToast, 3000); // Retoma o timer
            }
        };

        // Eventos de Touch (Celular)
        toast.addEventListener('touchstart', onDragStart, {passive: true});
        toast.addEventListener('touchmove', onDragMove, {passive: true});
        toast.addEventListener('touchend', onDragEnd);
        
        // Eventos de Mouse (Computador)
        toast.addEventListener('mousedown', onDragStart);
        document.addEventListener('mousemove', onDragMove);
        document.addEventListener('mouseup', onDragEnd);
    }
    function openModal(id) { document.getElementById(id).classList.add('open'); }
    function closeModal(id) { document.getElementById(id).classList.remove('open'); }

    // --- NAVEGAÇÃO ---
    function navTo(pageId) {
        document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + pageId).classList.add('active');
        document.querySelector(`.nav-item[data-target="${pageId}"]`).classList.add('active');

        document.getElementById('cart-btn').style.display = (pageId === 'sales') ? 'flex' : 'none';

        if(pageId === 'home') renderHome();
        if(pageId === 'finance') renderFinance();
        if(pageId === 'production') renderOPSelect();
        if(pageId === 'stock') { renderStockRaw(); renderStockFinished(); }
        if(pageId === 'sales') { renderCatalog(); renderClients(); }
    }

    // --- 1. HOME & FINANÇAS ---
    function renderHome() {
        const totalVendas = db.sales.reduce((a, b) => a + b.total, 0);
        const pct = Math.min(100, (totalVendas / db.target) * 100);
        document.getElementById('progress-bar').style.width = pct + '%';
        document.getElementById('progress-txt').innerText = pct.toFixed(1) + '%';
    }

function renderFinance() {
        // Atualiza os seletores de cliente no filtro
        const sel = document.getElementById('nf-client-filter');
        const currentVal = sel.value;
        sel.innerHTML = '<option value="ALL">Todos os Clientes</option>';
        db.clients.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
        sel.value = currentVal || "ALL";

        // Chama a renderização da lista
        renderNFList();

        // O resto do cálculo do DRE (Copia o que te mandei na interação anterior)
        const totalVendas = db.sales.reduce((a, b) => a + b.total, 0);
        const imposto = totalVendas * 0.068; 
        const liquida = totalVendas - imposto;
        let cmvReal = totalVendas * 0.384; 
        if(cmvReal === 0 && totalVendas === 0) cmvReal = 1840; 
        const despesasFixas = 4500;
        const lucro = liquida - cmvReal - despesasFixas;

        document.getElementById('fin-receber').innerText = totalVendas.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        document.getElementById('dre-receita').innerText = totalVendas.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        document.getElementById('dre-imposto').innerText = imposto.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        document.getElementById('dre-liquida').innerText = liquida.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        document.getElementById('dre-cmv').innerText = cmvReal.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        
        const lucroEl = document.getElementById('dre-lucro');
        lucroEl.innerText = lucro.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        lucroEl.style.color = lucro >= 0 ? 'green' : 'red';
    }
function renderNFList() {
        const container = document.getElementById('nf-list-container');
        const filter = document.getElementById('nf-client-filter').value;
        container.innerHTML = '';
        
        let filteredSales = db.sales;
        if(filter !== "ALL") {
            filteredSales = db.sales.filter(s => s.client === filter);
        }

        let totalFiltered = 0;

        filteredSales.forEach(sale => {
            totalFiltered += sale.total;
            const statusClass = sale.status === 'Paga' ? 'status-paga' : 'status-pendente';
            container.innerHTML += `
            <div class="nf-item" onclick="openNFManage(${sale.id})">
                <div class="nf-info">
                    <h4>NF-e ${sale.nfNum}</h4>
                    <p>${sale.client} • ${sale.date}</p>
                </div>
                <div class="nf-val">
                    <strong>R$ ${sale.total.toFixed(2)}</strong>
                    <span class="status-badge ${statusClass}">${sale.status}</span>
                </div>
            </div>`;
        });

        if(filteredSales.length === 0) container.innerHTML = '<p style="text-align:center; color:#999; font-size:0.9rem;">Nenhuma nota encontrada.</p>';
        document.getElementById('nf-total-filtered').innerText = totalFiltered.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
    }
	function openNFManage(id) {
        const sale = db.sales.find(s => s.id === id);
        document.getElementById('manage-nf-id').value = sale.id;
        document.getElementById('manage-nf-num').innerText = sale.nfNum;
        document.getElementById('manage-nf-client').innerText = sale.client;
        document.getElementById('manage-nf-total').innerText = sale.total.toFixed(2);
        
        const statusEl = document.getElementById('manage-nf-status');
        statusEl.innerText = sale.status;
        statusEl.className = 'status-badge ' + (sale.status === 'Paga' ? 'status-paga' : 'status-pendente');

        const btnPay = document.getElementById('btn-pay-nf');
        if(sale.status === 'Paga') {
            btnPay.style.display = 'none';
        } else {
            btnPay.style.display = 'block';
        }

        openModal('nf-manage-modal');
    }

    function toggleNFStatus() {
        const id = parseInt(document.getElementById('manage-nf-id').value);
        const sale = db.sales.find(s => s.id === id);
        sale.status = 'Paga';
        showToast(`Pagamento da NF-e ${sale.nfNum} confirmado!`, 'success');
        closeModal('nf-manage-modal');
        renderFinance(); // Re-renderiza a lista
    }

    function emitCCe() {
        const num = document.getElementById('manage-nf-num').innerText;
        const motivo = prompt(`Digite a justificativa para a Carta de Correção da NF-e ${num}:`);
        if(motivo && motivo.length > 10) {
            showToast('Carta de Correção Eletrônica (CC-e) transmitida à Sefaz.', 'success');
            closeModal('nf-manage-modal');
        } else if(motivo) {
            showToast('A Sefaz exige no mínimo 15 caracteres na justificativa.', 'error');
        }
    }
    // --- 2. PRODUÇÃO (BOM & OP Workflow) ---
    function switchProdTab(tab) {
        ['nova', 'lista', 'nfc'].forEach(t => {
            document.getElementById('tab-' + t).classList.remove('active');
            document.getElementById('prod-' + t + '-content').style.display = 'none';
        });
        document.getElementById('tab-' + tab).classList.add('active');
        document.getElementById('prod-' + tab + '-content').style.display = 'block';
        if(tab === 'lista') renderOPList();
    }

    function renderOPSelect() {
        const sel = document.getElementById('op-product');
        sel.innerHTML = '<option value="">Selecione o Produto...</option>';
        db.products.forEach(p => sel.innerHTML += `<option value="${p.id}">${p.name}</option>`);
    }

    function previewBOM() {
        const pId = document.getElementById('op-product').value;
        const qty = parseInt(document.getElementById('op-qty').value) || 1;
        const preview = document.getElementById('bom-preview');
        
        if(!pId) { preview.style.display = 'none'; return; }
        
        const prod = db.products.find(x => x.id == pId);
        let html = `<strong>Ficha Técnica p/ ${qty} Lote(s):</strong><ul style="margin:5px 0; padding-left:20px;">`;
        let canProduce = true;

        prod.recipe.forEach(r => {
            const insumo = db.insumos.find(i => i.id === r.id);
            const needed = r.qty * qty;
            const hasStock = insumo.stock >= needed;
            if(!hasStock) canProduce = false;
            html += `<li style="color:${hasStock ? 'green' : 'red'}">${needed.toFixed(2)} ${insumo.name} (Estoque: ${insumo.stock})</li>`;
        });
        html += `</ul>`;
        if(!canProduce) html += `<div style="color:red; font-weight:bold; margin-top:5px;"><i class="fas fa-ban"></i> Insumos insuficientes!</div>`;
        
        preview.innerHTML = html;
        preview.style.display = 'block';
        preview.dataset.can = canProduce;
    }

    function createOP() {
        const pId = document.getElementById('op-product').value;
        const qty = parseInt(document.getElementById('op-qty').value);
        if(!pId) return showToast('Selecione um produto!', 'error');
        if(document.getElementById('bom-preview').dataset.can === "false") return showToast('Falta insumo no estoque!', 'error');

        opCounter++;
        db.ops.unshift({ id: opCounter, pId: pId, qty: qty, status: 'Aberta', date: new Date().toLocaleDateString() });
        showToast(`OP #${opCounter} Aberta com sucesso!`, 'success');
        document.getElementById('op-product').value = "";
        document.getElementById('bom-preview').style.display = 'none';
        switchProdTab('lista');
    }

    function renderOPList() {
        const c = document.getElementById('op-list-container');
        c.innerHTML = '';
        if(db.ops.length === 0) return c.innerHTML = '<p style="text-align:center; color:#999;">Nenhuma OP registrada.</p>';
        
        db.ops.forEach(op => {
            const prod = db.products.find(x => x.id == op.pId);
            let btnHtml = '';
            let badgeCls = op.status.toLowerCase().replace('ç','c').replace(' ', '');
            
            if(op.status === 'Aberta') {
                btnHtml = `<button class="btn-small btn-primary" onclick="changeOPStatus(${op.id}, 'Em Produção')">Iniciar Produção</button>`;
            } else if(op.status === 'Em Produção') {
                btnHtml = `<button class="btn-small btn-secondary" onclick="changeOPStatus(${op.id}, 'Concluída')">Finalizar e Baixar Estoque</button>`;
            }

            c.innerHTML += `
            <div class="product-item" style="flex-direction:column; align-items:flex-start;">
                <div style="width:100%; display:flex; justify-content:space-between; margin-bottom:10px;">
                    <strong>OP #${op.id} <span style="font-size:0.7rem; font-weight:normal; color:#888;">(${op.date})</span></strong>
                    <span class="status-badge status-${badgeCls}">${op.status}</span>
                </div>
                <div style="margin-bottom:10px; font-size:0.9rem;">Gerar: <b>${op.qty}x ${prod.name}</b></div>
                ${btnHtml ? `<div style="width:100%; display:flex; gap:10px;">${btnHtml}<button class="btn-small btn-outline" onclick="changeOPStatus(${op.id}, 'Cancelada')">Cancelar</button></div>` : ''}
            </div>`;
        });
    }

    function changeOPStatus(id, status) {
        const op = db.ops.find(o => o.id === id);
        if(status === 'Concluída') {
            const prod = db.products.find(x => x.id == op.pId);
            // Dá baixa nos insumos
            prod.recipe.forEach(r => {
                const ins = db.insumos.find(i => i.id === r.id);
                ins.stock -= (r.qty * op.qty);
            });
            // Entra produto acabado
            prod.stock += op.qty;
            showToast(`Estoque Atualizado! +${op.qty} ${prod.name}`, 'success');
        }
        op.status = status;
        renderOPList();
    }

    // --- 3. CHÃO DE FÁBRICA (NFC & PERDAS) ---
    function simulateNFC() {
        document.getElementById('nfc-locked').style.display = 'none';
        document.getElementById('nfc-unlocked').style.display = 'block';
        showToast('Acesso Liberado', 'info');
        renderTabletRaw();
    }
    function lockNFC() {
        document.getElementById('nfc-unlocked').style.display = 'none';
        document.getElementById('nfc-locked').style.display = 'block';
    }
// --- MÓDULO: CHÃO DE FÁBRICA (NFC COMPLETO) ---
    function renderTabletRaw() {
        const c = document.getElementById('tablet-raw-list');
        c.innerHTML = '';
        db.insumos.forEach(i => {
            c.innerHTML += `
            <div class="product-item" style="flex-direction:column; gap:10px; align-items:stretch;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h4 style="margin:0; font-size:1rem;">${i.name}</h4>
                    <span style="font-size:0.85rem; color:#555;">Estoque: <b>${i.stock.toFixed(2)}</b></span>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                    <button class="btn-small" style="background:#1565C0; color:white; border:none; border-radius:6px; padding:10px 5px;" onclick="promptWithdraw(${i.id}, '${i.name}')"><i class="fas fa-hand-holding-box"></i> Baixar</button>
                    <button class="btn-small" style="background:var(--brand-red); color:white; border:none; border-radius:6px; padding:10px 5px;" onclick="openLossModal(${i.id}, '${i.name}')"><i class="fas fa-trash"></i> Perda</button>
                    <button class="btn-small" style="background:var(--brand-yellow); color:var(--brand-dark); border:none; border-radius:6px; padding:10px 5px;" onclick="requestInsumo('${i.name}')"><i class="fas fa-bell"></i> Pedir</button>
                </div>
            </div>`;
        });
    }

    function promptWithdraw(id, name) {
        const qty = prompt(`Quantas unidades de ${name} você retirou do almoxarifado?`);
        if(qty && !isNaN(qty) && qty > 0) {
            const insumo = db.insumos.find(x => x.id == id);
            if(insumo.stock < qty) return showToast('Estoque insuficiente para esta retirada.', 'error');
            insumo.stock -= parseFloat(qty);
            showToast(`Retirada de ${qty}x ${name} registrada.`, 'success');
            renderTabletRaw();
        }
    }

    function requestInsumo(name) {
        showToast(`Alerta de Suprimento: Pedido de ${name} enviado ao setor de Compras!`, 'info');
    }
    function openLossModal(id, name) {
        document.getElementById('loss-item-id').value = id;
        document.getElementById('loss-item-name').innerText = name;
        openModal('loss-modal');
    }
    function confirmLoss() {
        const id = document.getElementById('loss-item-id').value;
        const qty = parseFloat(document.getElementById('loss-qty').value);
        const insumo = db.insumos.find(x => x.id == id);
        if(insumo.stock < qty) return showToast('Estoque insuficiente.', 'error');
        insumo.stock -= qty;
        showToast(`Custo registrado: Perda de ${qty}x ${insumo.name}.`, 'error');
        closeModal('loss-modal');
        renderTabletRaw();
    }

    // --- 4. ESTOQUE & NFE ---
    function switchStockTab(tab) {
        ['raw', 'finished', 'nfe'].forEach(t => {
            document.getElementById('tab-' + t).classList.remove('active');
            document.getElementById('stock-' + t + '-content').style.display = 'none';
        });
        document.getElementById('tab-' + tab).classList.add('active');
        document.getElementById('stock-' + tab + '-content').style.display = 'block';
    }
    function renderStockRaw() {
        const c = document.getElementById('stock-raw-content');
        c.innerHTML = '';
        db.insumos.forEach(i => {
            const low = i.stock <= i.min;
            c.innerHTML += `<div class="product-item">
                <div class="prod-info"><h4>${i.name}</h4><p>R$ ${i.cost.toFixed(2)} / un</p></div>
                <div style="text-align:right;"><span style="font-size:1.1rem; font-weight:bold; color:${low?'red':'green'}">${i.stock.toFixed(2)}</span>${low ? '<br><span class="status-badge status-producao">Comprar</span>' : ''}</div>
            </div>`;
        });
    }
    function renderStockFinished() {
        const c = document.getElementById('stock-finished-content');
        c.innerHTML = '';
        db.products.forEach(p => {
            c.innerHTML += `<div class="product-item">
                <div class="prod-info"><h4>${p.name}</h4><p>Venda: R$ ${p.price.toFixed(2)}</p></div>
                <div style="font-size:1.1rem; font-weight:bold;">${p.stock} un.</div>
            </div>`;
        });
    }
    function processNFE() {
        showToast('Validando XML na Sefaz...', 'info');
        setTimeout(() => {
            const f = db.insumos.find(i => i.id === 101); f.stock += 50;
            showToast('XML Processado! +50 Farinha alimentados.', 'success');
            document.getElementById('nf-key').value = '';
            renderStockRaw();
            switchStockTab('raw');
        }, 1500);
    }

    // --- 5. VENDAS & CLIENTES ---
    function switchSalesTab(tab) {
        document.getElementById('tab-pdv').classList.remove('active');
        document.getElementById('tab-cli').classList.remove('active');
        document.getElementById('sales-pdv-content').style.display = 'none';
        document.getElementById('sales-cli-content').style.display = 'none';
        
        document.getElementById('tab-' + tab).classList.add('active');
        document.getElementById('sales-' + tab + '-content').style.display = 'block';
    }

    function renderClients() {
        const list = document.getElementById('clients-list');
        const sel = document.getElementById('client-select');
        list.innerHTML = '';
        sel.innerHTML = '<option value="">Selecione o Cliente...</option>';
        
        db.clients.forEach((c, i) => {
            sel.innerHTML += `<option value="${c}">${c}</option>`;
            list.innerHTML += `
            <li class="product-item" onclick="openEditClient(${i})" style="cursor:pointer">
                <span style="font-weight:700;">${c}</span><i class="fas fa-pen" style="color:#ddd;"></i>
            </li>`;
        });
    }

    function openEditClient(index) {
        document.getElementById('cli-modal-title').innerText = "Editar Cliente";
        document.getElementById('cli-id').value = index;
        document.getElementById('cli-name').value = db.clients[index];
        document.getElementById('btn-del-cli').style.display = 'block';
        openModal('client-modal');
    }

    function saveClient() {
        const name = document.getElementById('cli-name').value.trim();
        const id = document.getElementById('cli-id').value;
        if(!name) return showToast('Nome inválido', 'error');
        if(id) db.clients[id] = name; else db.clients.push(name);
        
        document.getElementById('cli-name').value = '';
        document.getElementById('cli-id').value = '';
        document.getElementById('cli-modal-title').innerText = "Novo Cliente";
        document.getElementById('btn-del-cli').style.display = 'none';
        
        closeModal('client-modal');
        renderClients();
        showToast('Cliente salvo!', 'success');
    }

    function deleteClient() {
        const id = document.getElementById('cli-id').value;
        db.clients.splice(id, 1);
        closeModal('client-modal');
        renderClients();
        showToast('Cliente removido.', 'success');
    }

    // --- PDV & CARRINHO ---
    function renderCatalog() {
        const c = document.getElementById('catalog-container');
        c.innerHTML = '';
        db.products.forEach(p => {
            const qty = db.cart[p.id] || 0;
            c.innerHTML += `
            <div class="product-item">
                <div class="prod-info">
                    <h4>${p.name} <span class="status-badge status-concluida" style="margin-left:5px;">${p.stock} est.</span></h4>
                    <p>R$ ${p.price.toFixed(2)}</p>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="btn-secondary" style="width:30px; height:30px; border-radius:50%; border:none; font-weight:bold;" onclick="cartAdd(${p.id}, -1)">-</button>
                    <strong>${qty}</strong>
                    <button class="btn-primary" style="width:30px; height:30px; border-radius:50%; border:none; font-weight:bold;" onclick="cartAdd(${p.id}, 1)">+</button>
                </div>
            </div>`;
        });
        document.getElementById('cart-count').innerText = Object.values(db.cart).reduce((a,b)=>a+b, 0);
    }

    function cartAdd(id, delta) {
        const p = db.products.find(x => x.id == id);
        if(!db.cart[id]) db.cart[id] = 0;
        const n = db.cart[id] + delta;
        if(n < 0) return;
        if(n > p.stock) return showToast('Estoque final insuficiente!', 'error');
        db.cart[id] = n;
        if(db.cart[id] === 0) delete db.cart[id];
        renderCatalog();
    }

    function openCart() {
        if(Object.keys(db.cart).length === 0) return showToast('Carrinho vazio!', 'error');
        const c = document.getElementById('cart-items');
        let html = ''; let total = 0;
        for(let id in db.cart) {
            const p = db.products.find(x => x.id == id);
            const sub = p.price * db.cart[id]; total += sub;
            html += `<div style="display:flex; justify-content:space-between; margin-bottom:10px; border-bottom:1px dashed #eee; padding-bottom:5px;">
                <div><strong>${p.name}</strong><br><small>${db.cart[id]} un x R$ ${p.price.toFixed(2)}</small></div>
                <strong>R$ ${sub.toFixed(2)}</strong>
            </div>`;
        }
        c.innerHTML = html;
        document.getElementById('cart-total').innerText = total.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
        
        document.getElementById('cart-title').innerText = "Resumo do Pedido";
        document.getElementById('cart-footer').style.display = 'block';
        const btn = document.getElementById('btn-finish-sale');
        btn.innerHTML = "Emitir NF-e e Faturar";
        btn.onclick = generateDANFE;

        openModal('cart-modal');
    }

    function generateDANFE() {
        const client = document.getElementById('client-select').value;
        if(!client) { showToast('Selecione um cliente!', 'error'); closeModal('cart-modal'); return; }
        
        let total = 0; let trs = ''; const numNota = Math.floor(Math.random() * 9000) + 1000;
        for(let id in db.cart) {
            const p = db.products.find(x => x.id == id);
            p.stock -= db.cart[id];
            const sub = p.price * db.cart[id]; total += sub;
            trs += `<tr><td>${p.id.toString().padStart(4,'0')}</td><td>${p.name}</td><td>UN</td><td>${db.cart[id]}</td><td>R$ ${sub.toFixed(2)}</td></tr>`;
        }
        db.sales.push({ id: Date.now(), total: total });

        const danfe = `
        <div class="danfe-box">
            <div style="display:flex; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:10px;">
                <div style="width:50%; border-right:1px solid #000;"><strong>DELICK'S INDÚSTRIA</strong><br>CNPJ: 12.345.678/0001-90</div>
                <div style="flex:1; text-align:center;">DANFE<br>Nº 000.00${numNota}</div>
            </div>
            <div style="border:1px solid #000; text-align:center; padding:5px; margin-bottom:10px; background:#f9f9f9; font-size:0.7rem;">
                CHAVE DE ACESSO<br>4326 0212 3456 7800 0190 5500 1000 00${numNota} 1123 4567<div class="barcode-mock"></div>
            </div>
            <div style="border:1px solid #000; padding:5px; margin-bottom:10px;"><strong>DESTINATÁRIO:</strong> ${client}</div>
            <table class="dre-table" style="border:1px solid #000;">
                <thead style="background:#eee;"><tr><th>CÓDIGO</th><th>DESCRIÇÃO</th><th>UN</th><th>QTD</th><th>TOTAL</th></tr></thead>
                <tbody>${trs}</tbody>
            </table>
            <div style="text-align:right; font-size:1rem; border:1px solid #000; padding:5px; background:#eee;"><strong>TOTAL: R$ ${total.toFixed(2)}</strong></div>
        </div>`;

        document.getElementById('cart-title').innerText = "NF-e Emitida";
        document.getElementById('cart-items').innerHTML = danfe;
        document.getElementById('cart-footer').style.display = 'none';
        
        const btn = document.getElementById('btn-finish-sale');
        btn.innerHTML = "<i class='fas fa-print'></i> Fechar Venda";
        document.getElementById('cart-footer').style.display = 'block';
        document.getElementById('cart-total').parentElement.style.display = 'none';

        btn.onclick = () => {
            db.cart = {};
            showToast('Faturamento Concluído.', 'success');
            closeModal('cart-modal');
            navTo('home');
        };
    }

    // INIT
    renderHome();
</script>
</body>
</html>
